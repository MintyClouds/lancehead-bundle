version: "3.7"
services:
  # Homer
  homer:
    image: b4bz/homer:${HOMER_VERSION}
    hostname: ${HOSTNAME}
    container_name: homer
    restart: unless-stopped
    volumes:
      - ./homer-config.yml:/www/assets/config.yml
      - ./dashboard-icons:/www/assets-ext/
      - ./mintyclouds-logo.png:/www/assets/mintyclouds-logo.png
    environment:
      - UID=1000
      - GID=1000
      - TZ=Europe/Moscow
    ports:
      - ${HOMER_WEB_PORT}:8080


  # Wiki.js
  wikijs-postgresql:
    image: postgres:${WIKIJS_POSTGRES_VERSION}
    container_name: wikijs-postgresql
    restart: unless-stopped
    environment:
      POSTGRES_PASSWORD: "${WIKIJS_POSTGRES_PASSWORD}"
      POSTGRES_USER: "${WIKIJS_POSTGRES_USER}"
      POSTGRES_DB: "${WIKIJS_POSTGRES_DB}"
    # ports:
    #   - "${WIKIJS_POSTGRES_PORT}:5432"
    volumes:
      - ${WIKIJS_POSTGRES_DATA_PATH}:/var/lib/postgresql/data

  wikijs:
    image: requarks/wiki:${WIKIJS_VERSION}
    hostname: ${HOSTNAME}
    container_name: wikijs
    restart: unless-stopped
    environment:
      DB_TYPE: postgres
      DB_HOST: wikijs-postgresql
      DB_PORT: 5432
      DB_USER: ${WIKIJS_POSTGRES_USER}
      DB_PASS: ${WIKIJS_POSTGRES_PASSWORD}
      DB_NAME: ${WIKIJS_POSTGRES_DB}
    ports:
      - ${WIKIJS_WEB_PORT}:3000
    depends_on:
      - wikijs-postgresql

  pigallery-nginx:
    image: nginx:${PIGALLERY_NGINX_VERSION}
    container_name: pigallery-nginx
    volumes:
      - ./pigallery-nginx.conf:/etc/nginx/nginx.conf
      - ${PIGALLERY_DATA_PATH}/nginx/error.log:/etc/nginx/error_log.log
      - ${PIGALLERY_DATA_PATH}/nginx/cache/:/etc/nginx/cache
    ports:
      - ${PIGALLERY_WEB_PORT}:3000
    restart: unless-stopped

  pigallery-db:
    container_name: pigallery-db
    image: mariadb:${PIGALLERY_MARIADB_VERSION}
    volumes:
      - ${PIGALLERY_DATA_PATH}/db-data:/var/lib/mysql
    environment:
      - MYSQL_ROOT_PASSWORD=${PIGALLERY_MARIADB_ROOT_PASSWORD}
      - MYSQL_USER=${PIGALLERY_MARIADB_USER}
      - MYSQL_PASSWORD=${PIGALLERY_MARIADB_PASSWORD}
      - MYSQL_DATABASE=${PIGALLERY_MARIADB_DB}

  pigallery:
    image: bpatrik/pigallery2:${PIGALLERY_VERSION}
    container_name: pigallery
    environment:
      - NODE_ENV=production # set to 'debug' for full debug logging
    volumes:
      - "${PIGALLERY_DATA_PATH}/pigallery2/config:/app/data/config"
      - "${PIGALLERY_DATA_PATH}/pigallery2/db-data:/app/data/db"
      - "${PIGALLERY_DATA_PATH}/pigallery2/tmp:/app/data/tmp"
      - "${PIGALLERY_GALLERY_PATH}:/app/data/images/gallery:ro"
      - "${PIGALLERY_MEDIA_PATH}/images:/app/data/images/media/images:ro"
      - "${PIGALLERY_MEDIA_PATH}/nsfw:/app/data/images/media/nsfw:ro"
    restart: unless-stopped
        command: |
          sh -c 'bin/wait-for pigallery-db:3306 --
          -Server-Database-mysql-host=pigallery-db 
          --Server-Database-mysql-username=${PIGALLERY_MARIADB_USER}
          --Server-Database-mysql-password=${PIGALLERY_MARIADB_PASSWORD}
          --Server-Database-mysql-database=${PIGALLERY_MARIADB_DB}'

